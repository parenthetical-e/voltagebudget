---
title: "Exp1 - Opt w_max and {A,phi)"
output: html_notebook
---

```{r, message=FALSE}
library(tidyverse)
library(gridExtra)
library(readr)

normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
}

data_summary <- function(x) {
   m <- mean(x)
   ymin <- m-mad(x)
   ymax <- m+mad(x)
   return(c(y=m, ymin=ymin, ymax=ymax))
}

mean_summary <- function(x) {
   m <- mean(x)
   return(c(y=m))
}
```

# Read and process all data

```{r, message=FALSE}
# --------------------------------------------------------------------
# Example voltage timecourses
fig0 <- read_csv("vm_comp_timecourse.csv")

# --------------------------------------------------------------------
# Sweep A
exp <- "72"
freqs <- c(8, 12, 20, 30)

# Load
fig1 <- NULL
for(freq in freqs){
  name <- paste("../data/exp", exp, "_d-2e-3_f", freq, ".csv", sep="")
  df <- read_csv(paste(name, sep=","))
  df %>%
    filter(n_spikes > 0) -> df
  
  df$freq <- rep(freq, nrow(df))
  fig1 <- rbind(fig1, df)
}

# Process
fig1 %>% 
  # Add delta_spikes
  mutate(delta_spikes = n_spikes - n_spikes_ref) %>% 
  # Re-norm V_osc
  mutate(V_osc = V_osc - V_osc_ref) -> fig1

# --------------------------------------------------------------------
# Summarize over As 
fig1 %>% 
  group_by(As, freq) %>% 
  summarise(
    V_osc = mean(V_osc), 
    V_comp = mean(V_comp), 
    errors = mean(errors), 
    variances = mean(variances)) -> fig2

rm(df, exp, freq, freqs, name)
```


# Budget intro

```{r, fig.width=1.5, fig.height=1.3}
fig0 %>% 
  filter(t > 0.15, t < 0.35) %>%
  ggplot(aes(x=t, ymin=-70e-3*1e3, ymax=vm*1e3)) +
  geom_ribbon(fill="blue", alpha=0.5) +
  geom_hline(yintercept=-50e-3*1e3, color="black", linetype="dotted", size=0.5) +
  geom_hline(yintercept=-70e-3*1e3, color="black", linetype="dotted", size=0.5) +
  labs(x="", y=expression(V[m] (mvolt))) +
  theme_classic() -> p1

fig0 %>% 
  filter(t > 0.15, t < 0.35) %>%
  ggplot(aes(x=t, ymin=-70e-3*1e3, ymax=osc*1e3)) +
  geom_ribbon(fill="red", alpha=0.5) +
  geom_ribbon(aes(x=t, ymin=osc*1e3, ymax=comp*1e3), fill="purple", alpha=0.5) +
  geom_hline(yintercept=-50e-3*1e3, color="black", linetype="dotted", size=0.5) +
  geom_hline(yintercept=-70e-3*1e3, color="black", linetype="dotted", size=0.5) +
  geom_rect(aes(xmin=0.23652 - 8e-3, xmax=0.23652 + 2e-3 + 0.03333333 + 8e-3, ymin=-70e-3*1e3, ymax=-50e-3*1e3),  fill=NA, color="black", alpha=0.01, size=.2) +
  # geom_hline(yintercept=-70e-3, color="black", size=1.5) +
  # geom_rect(aes(xmin=0.23652 - 2e-3, xmax=0.23652, ymin=-70e-3, ymax=-50e-3), color="grey", alpha=0.5) +
  # geom_rect(aes(xmin=0.23652 + 2e-3, xmax=0.23652 + 2e-3 + 0.03333333, ymin=-70e-3, ymax=-50e-3), fill=NA, color="grey", alpha=0.1) +
  labs(x="Time (s)", y="") +
  theme_classic() -> p2

fig0 %>% 
  filter(t > 0.23652 - 8e-3, t < 0.23652 + 2e-3 + 0.03333333 + 8e-3) %>%
  ggplot(aes(x=t, ymin=-70e-3*1e3, ymax=osc*1e3)) +
  geom_ribbon(fill="red", alpha=0.5) +
  geom_ribbon(aes(x=t, ymin=osc*1e3, ymax=comp*1e3), fill="purple", alpha=0.5) +
  # geom_hline(yintercept=-50e-3, color="black", linetype="dotted", size=0.5) +
  # geom_hline(yintercept=-70e-3, color="black", linetype="dotted", size=0.5) +
  geom_rect(aes(xmin=0.23652 - 2e-3, xmax=0.23652, ymin=-70e-3*1e3, ymax=-50e-3*1e3), fill="grey", alpha=0.01) +
  geom_rect(aes(xmin=0.23652 + 2e-3, xmax=0.23652 + 2e-3 + 0.03333333, ymin=-70e-3*1e3, ymax=-50e-3*1e3),  fill="grey", alpha=0.01) +
  geom_rect(aes(xmin=0.23652 - 8e-3, xmax=0.23652 + 2e-3 + 0.03333333 + 8e-3, ymin=-70e-3*1e3, ymax=-50e-3*1e3),  fill=NA, color="black", alpha=0.01, size=.2) +
  labs(x="", y="") +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      # axis.title.x=element_blank(),
      # axis.title.y=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) -> p3

plot_grid <- rbind(c(1 , 1, NA), c(2, 2, 3))
grid.arrange(p1, p2, p3, layout_matrix=plot_grid)
rm(p1, p2, p3, plot_grid)
```
           
# Trade-off

```{r, fig.width=1.9, fig.height=1.8}
fig2 %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=errors*1e3, y=variances*1e3, color=V_osc*1e3)) +
  geom_point(size=0.05, alpha=.1) +
  scale_color_gradient(low="purple", high="red", name=expression(V[o] (mvolt))) +
  labs(x="Error (ms)", y="Variance (ms)") +
  theme_classic() +
  theme(
    legend.position="bottom", 
    legend.key.size = unit(.4, "cm"),
    legend.title = element_text(size=8),
    legend.text = element_text(size=8)) -> p1

fig2 %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=V_osc*1e3, y=errors*1e3)) +
  geom_point(size=0.05, alpha=1, color="black") + 
  labs(x=expression(V[o] (mvolt)), y="Error (ms)") +
  lims(y=c(0, 10)) +
  theme_classic() -> p2

fig2 %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=V_osc*1e3, y=variances*1e3)) +
  geom_point(size=0.05, alpha=1, color="black") + 
  labs(x=expression(V[o] (mvolt)), y="Variance (ms)") +
  # lims(y=c(0, 10)) +
  theme_classic() -> p3

fig1 %>% 
  filter(rank == 0, freq == 20) %>% 
  ggplot(aes(x=As*1e9, y=V_osc*1e3)) +
  geom_point(size=0.1, alpha=0.6, color="black") + 
  labs(x="A (namp)", y=expression(V[o] (mvolt))) +
  theme_classic() -> p4

plot_grid <- rbind(
  c(NA, NA, NA, 4, 4,   4),
  c(NA, NA, NA, 4, 4,   4),
  c(1, 1, 1, 2, 2,   2),
  c(1,  1,  1,  2, 2,   2),
  c(1,  1,  1,  3, 3,   3),
  c(1,  1,  1,  3, 3,   3))#,
  # c(1,  1,  1,  NA, NA, NA))
grid.arrange(p1, p2, p3, p4, layout_matrix=plot_grid)
rm(p1, p2, p3, plot_grid)
```

# Bound 1 - V_osc/V_comp (f = 20)

```{r, fig.width=2.7, fig.height=2.2}
fig1 %>% 
  filter(V_osc/V_comp <= 3) %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=V_osc/V_comp, y=errors*1e3)) +
  geom_point(size=0.01, alpha=0.01, color="grey") + 
  geom_vline(xintercept = 1, alpha=0.7, color="purple", linetype="dashed") +
  geom_vline(xintercept = 0.5, alpha=0.5, color="purple", linetype="dashed") +
  theme_classic() +
  geom_line(data=filter(fig2, freq==20), 
            aes(x=V_osc/V_comp, y=errors*1e3), 
            color="black", size=0.8) +
  labs(x=expression(V[o]/V[c]), y="Error (ms)") -> p1

fig1 %>% 
  filter(V_osc/V_comp <= 3) %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=V_osc/V_comp, y=variances*1e3)) +
  geom_point(size=0.01, alpha=0.01, color="grey") + 
  geom_vline(xintercept = 1, alpha=0.7, color="purple", linetype="dashed") +
  geom_vline(xintercept = 0.5, alpha=0.5, color="purple", linetype="dashed") +
  theme_classic() +
  geom_line(data=filter(fig2, freq==20), 
            aes(x=V_osc/V_comp, y=variances*1e3), 
            color="black", size=0.7, alpha=1) +
  labs(x=expression(V[o]/V[c]), y="Variance (ms)") -> p2

max_N <- max(fig1$N)

fig1 %>% 
  filter(freq==20) %>% 
  filter(V_osc/V_comp <= 3) %>% 
  filter(N %in% sample(1:max_N, 16, replace = FALSE)) %>% 
  ggplot(aes(x=V_osc/V_comp, y=errors*1e3)) +
  geom_point(size=.1, alpha=0.1, color="grey") + 
  geom_vline(xintercept = 1, alpha=0.7, color="purple", linetype="dashed") +
  geom_vline(xintercept = 0.5, alpha=0.5, color="purple", linetype="dashed") +
  facet_wrap(~rank, nrow=2) +
  theme_classic() + 
  scale_x_continuous(breaks=c(0, 1, 2)) +
  scale_y_continuous(breaks=c(0, 10)) +
  theme(
    strip.text.x = element_text(size=0),
    strip.background = element_blank(),
    # axis.line=element_blank(),
    # axis.text.x=element_blank(),
    # axis.text.y=element_blank(),
    # axis.ticks=element_blank(),
    # axis.title.x=element_blank(),
    # axis.title.y=element_blank(),
    panel.background=element_blank(),
    # panel.border=element_blank(),
    # panel.grid.major=element_blank(),
    # panel.grid.minor=element_blank(),
    plot.background=element_blank()) +
  labs(x=expression(V[o]/V[c]), y="Error (ms)") -> p3

plot_grid <- rbind(
  c(1, 1, 1, 2, 2), 
  c(1, 1, 1, 2, 2), 
  c(1, 1, 1, 2, 2),
  c(1, 1, 1, NA, NA),
  c(3, 3, 3, 3, 3),
  c(3, 3, 3, 3, 3))
grid.arrange(p1, p2, p3, layout_matrix=plot_grid)
rm(p1, p2, p3, plot_grid, max_N)
```

# Bound 2 - n_spikes < (0, 1)

```{r, fig.width=2.6, fig.height=2}
max_N <- max(fig1$N)

fig1 %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=V_osc*1e3, y=variances*1e3)) +
  geom_point(size=0.1, alpha=0.1, color="grey") + 
  theme_classic() +
  geom_line(aes(x=V_osc*1e3, y=variances_pop*1e3), 
            color="black", size=0.7, alpha=1) +
  labs(x=expression(V[o] (mvolt)), y="Variance (ms)") -> p1


fig1 %>% 
  filter(freq==20) %>% 
  filter(V_osc/V_comp <= 3) %>% 
  filter(N %in% sample(1:max_N, 10, replace = FALSE)) %>% 
  ggplot(aes(x=V_osc*1e3, y=variances*1e3, color=factor(delta_spikes))) +
  geom_point(size=1, alpha=1) + 
  facet_wrap(~rank, ncol=2) +
  geom_line(aes(x=V_osc*1e3, y=variances_pop*1e3), 
            color="black", size=0.7, alpha=1) +
  scale_colour_brewer(palette = "Accent", name="N spikes") +
  scale_x_continuous(breaks=c(0, 3, 6)) +
  scale_y_continuous(breaks=c(6, 8)) +
  labs(x=expression(V[o] (mvolt)), y="Variance (ms)") +
  theme_classic() + theme(
    # legend.position="bottom",
    strip.text.x = element_text(size=0),
    strip.background = element_blank(),
    legend.position="none", 
    legend.key.size = unit(.5, "cm"),
    legend.title = element_text(size=8),
    legend.text = element_text(size=8),
    # axis.line=element_blank(),
    # axis.text.x=element_blank(),
    # axis.text.y=element_blank(),
    # axis.ticks=element_blank(),
    # axis.title.x=element_blank(),
    # axis.title.y=element_blank(),
    panel.background=element_blank(),
    # panel.border=element_blank(),
    # panel.grid.major=element_blank(),
    # panel.grid.minor=element_blank(),
    plot.background=element_blank()) -> p2

fig1 %>% 
  filter(freq==20) %>% 
  filter(V_osc/V_comp <= 3) %>% 
  filter(N %in% sample(1:max_N, 5, replace = FALSE)) %>% 
  ggplot(aes(x=V_osc*1e3, y=errors*1e3, color=factor(delta_spikes))) +
  geom_point(size=1, alpha=1) + 
  facet_wrap(~rank, ncol=1) +
  geom_line(aes(x=V_osc*1e3, y=errors_pop*1e3), 
            color="black", size=0.7, alpha=1) +
  scale_colour_brewer(palette = "Accent", name="N spikes") +
  scale_x_continuous(breaks=c(0, 3, 6)) +
  scale_y_continuous(breaks=c(2, 8)) +
  labs(x=expression(V[o] (mvolt)), y="Error (ms)") +
  theme_classic() + theme(
    # legend.position="bottom",
    strip.text.x = element_text(size=0),
    strip.background = element_blank(),
    legend.position="right", 
    legend.key.size = unit(.5, "cm"),
    legend.title = element_text(size=8),
    legend.text = element_text(size=8),
    # axis.line=element_blank(),
    # axis.text.x=element_blank(),
    # axis.text.y=element_blank(),
    # axis.ticks=element_blank(),
    # axis.title.x=element_blank(),
    # axis.title.y=element_blank(),
    panel.background=element_blank(),
    # panel.border=element_blank(),
    # panel.grid.major=element_blank(),
    # panel.grid.minor=element_blank(),
    plot.background=element_blank()) -> p3

plot_grid <- rbind(
  c(1,  1,  1,  2, 2, 2, 2, 3, 3, 3, 3),
  c(1,  1,  1,  2, 2, 2, 2, 3, 3, 3, 3),
  c(NA, NA, NA, 2, 2, 2, 2, 3, 3, 3, 3),
  c(NA, NA, NA, 2, 2, 2, 2, 3, 3, 3, 3),
  c(NA, NA, NA, 2, 2, 2, 2, 3, 3, 3, 3))
grid.arrange(p1, p2, p3, layout_matrix=plot_grid)
rm(p1, p2, plot_grid, max_N)
```


# Freq effects - var reduction versus additional 'sampling'?

```{r, fig.width=2.2, fig.height=1.5}
fig1 %>%
  filter(rank == 0) %>% 
  ggplot(aes(x=errors_pop*1e3, y=variances_pop*1e3, color=freq)) +
  geom_point(size=0.05, alpha=0.6) + 
  labs(x="Error (ms)", y="Variance (ms)") +
  theme_classic() +
  scale_color_gradient(low="grey", high="black") +
  theme(legend.position="right") +
  labs(x="Error (ms)", y="Variance (ms)") -> p1
  
plot_grid <- rbind(
  c(1))
  
grid.arrange(p1, layout_matrix=plot_grid)
rm(p1, plot_grid)
```

# Homeostatis - bigger budgets for more granular control.



