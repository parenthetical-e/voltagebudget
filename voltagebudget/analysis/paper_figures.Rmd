---
title: "Exp1 - Opt w_max and {A,phi)"
output: html_notebook
---

```{r, message=FALSE}
library(tidyverse)
library(gridExtra)
library(readr)

normalize <- function(x) {
    return ((x - min(x)) / (max(x) - min(x)))
}
```

# Read and process all data

```{r, message=FALSE}
# -
# Example voltage timecourses
results0 <- read_csv("vm_comp_timecourse.csv")

# -
# Sweep A
exp <- "72"
freqs <- c(8, 12, 20, 30)

# Load
results1 <- NULL
for(freq in freqs){
  name <- paste("../data/exp", exp, "_d-2e-3_f", freq, ".csv", sep="")
  df <- read_csv(paste(name, sep=","))
  df %>%
    filter(n_spikes > 0) -> df
  
  df$freq <- rep(freq, nrow(df))
  results1 <- rbind(results1, df)
}

# Process
results1 %>% 
  # Add delta_spikes
  mutate(delta_spikes = n_spikes - n_spikes_ref) %>% 
  # Re-norm V_osc
  mutate(V_osc = V_osc - V_osc_ref) -> results1

rm(df, exp, freq, freqs, name)
```


# Budget intro

```{r, fig.width=1.5, fig.height=1.3}
results0 %>% 
  filter(t > 0.15, t < 0.35) %>%
  ggplot(aes(x=t, ymin=-70e-3, ymax=vm)) +
  geom_ribbon(fill="blue", alpha=0.5) +
  geom_hline(yintercept=-50e-3, color="black", linetype="dotted", size=0.5) +
  geom_hline(yintercept=-70e-3, color="black", linetype="dotted", size=0.5) +
  labs(x="", y="Vm") +
  theme_classic() -> p1

results0 %>% 
  filter(t > 0.15, t < 0.35) %>%
  ggplot(aes(x=t, ymin=-70e-3, ymax=osc)) +
  geom_ribbon(fill="red", alpha=0.5) +
  geom_ribbon(aes(x=t, ymin=osc, ymax=comp), fill="purple", alpha=0.5) +
  geom_hline(yintercept=-50e-3, color="black", linetype="dotted", size=0.5) +
  geom_hline(yintercept=-70e-3, color="black", linetype="dotted", size=0.5) +
  geom_rect(aes(xmin=0.23652 - 8e-3, xmax=0.23652 + 2e-3 + 0.03333333 + 8e-3, ymin=-70e-3, ymax=-50e-3),  fill=NA, color="black", alpha=0.01, size=.2) +
  # geom_hline(yintercept=-70e-3, color="black", size=1.5) +
  # geom_rect(aes(xmin=0.23652 - 2e-3, xmax=0.23652, ymin=-70e-3, ymax=-50e-3), color="grey", alpha=0.5) +
  # geom_rect(aes(xmin=0.23652 + 2e-3, xmax=0.23652 + 2e-3 + 0.03333333, ymin=-70e-3, ymax=-50e-3), fill=NA, color="grey", alpha=0.1) +
  labs(x="Times (s)", y="") +
  theme_classic() -> p2

results0 %>% 
  filter(t > 0.23652 - 8e-3, t < 0.23652 + 2e-3 + 0.03333333 + 8e-3) %>%
  ggplot(aes(x=t, ymin=-70e-3, ymax=osc)) +
  geom_ribbon(fill="red", alpha=0.5) +
  geom_ribbon(aes(x=t, ymin=osc, ymax=comp), fill="purple", alpha=0.5) +
  # geom_hline(yintercept=-50e-3, color="black", linetype="dotted", size=0.5) +
  # geom_hline(yintercept=-70e-3, color="black", linetype="dotted", size=0.5) +
  geom_rect(aes(xmin=0.23652 - 2e-3, xmax=0.23652, ymin=-70e-3, ymax=-50e-3), fill="grey", alpha=0.01) +
  geom_rect(aes(xmin=0.23652 + 2e-3, xmax=0.23652 + 2e-3 + 0.03333333, ymin=-70e-3, ymax=-50e-3),  fill="grey", alpha=0.01) +
  geom_rect(aes(xmin=0.23652 - 8e-3, xmax=0.23652 + 2e-3 + 0.03333333 + 8e-3, ymin=-70e-3, ymax=-50e-3),  fill=NA, color="black", alpha=0.01, size=.2) +
  labs(x="", y="") +
  theme(axis.line=element_blank(),
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      axis.ticks=element_blank(),
      # axis.title.x=element_blank(),
      # axis.title.y=element_blank(),
      legend.position="none",
      panel.background=element_blank(),
      panel.border=element_blank(),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      plot.background=element_blank()) -> p3

plot_grid <- rbind(c(1 , 1, NA), c(2, 2, 3))
grid.arrange(p1, p2, p3, layout_matrix=plot_grid)
rm(p1, p2, p3, plot_grid)
```
           

# Trade-off

```{r, fig.width=1.3, fig.height=1.9}
results1 %>% 
  filter(rank == 0) %>% 
  ggplot(aes(x=As*1e9, y=errors_pop*1e3, color=freq)) +
  geom_point(size=0.05, alpha=0.6) + 
  labs(x="A (namp)", y="Error (ms)") +
  theme_classic() +
  scale_color_gradient2(low="grey", high="orange", midpoint = 1) +
  theme(legend.position="none") -> p1

results1 %>% 
  filter(rank == 0) %>% 
  ggplot(aes(x=As*1e9, y=variances_pop*1e3, color=freq)) +
  geom_point(size=0.05, alpha=0.6) + 
  labs(x="A (namp)", y="Variance (ms)") +
  lims(y=c(0, 12)) +
  theme_classic() +
  scale_color_gradient2(low="grey", high="orange", midpoint = 1) +
  theme(legend.position="right") -> p2

results1 %>% 
  filter(rank == 0) %>% 
  ggplot(aes(x=errors_pop*1e3, y=variances_pop*1e3, color=freq)) +
  geom_point(size=0.05, alpha=0.6) + 
  labs(x="Error (ms)", y="Variance (ms)") +
  theme_classic() +
  scale_color_gradient2(low="grey", high="orange", midpoint = 1) +
  theme(legend.position="none") +
  labs(x="Error (ms)", y="Variance (ms)") -> p3
  
plot_grid <- rbind(c(1, 1, NA), c(2, 2, 2), c(3, 3, NA))
grid.arrange(p1, p2, p3, layout_matrix=plot_grid)
```


# Bound 1 - V_osc/V_comp (f = 20)

```{r, fig.width=1.25, fig.height=1.15}
results1 %>% 
  filter(freq == 20) %>% 
  ggplot(aes(x=As*1e9, y=1e3*V_osc)) +
  geom_point(size=0.1, alpha=0.01) + 
  labs(x="A (namp)", y="V_osc (mvolt)") +
  theme_classic() -> p1

plot_grid <- rbind(c(1))
grid.arrange(p1, layout_matrix=plot_grid)
```
